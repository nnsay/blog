---
title: 阿里云迁移中吃过的亏(持续更新)
date: 2021-08-17 11:50:57
tags:
  - Aliyun
  - DevOps
  - CloudNative
excerpt: AWS迁移到阿里云过程中遭遇的问题以及解决方案
---

### 0. 更新日志

- 2021-8-17: ASK/SLS/ECI/KMS/OSS
- 2021-11-3: CR
- 2022-2-4: 企业版 CR 限制
- 2022-11-22: FC 同步调用实例限制

### 1. 背景

7 月中旬完成了 AWS 到 Alicloud 的迁移, 迁移前后通过压测和生产环境的持续巡检发现了一些问题, 列举出来希望后来人避免跳坑.

<!-- more -->

### 2. 吃亏事件

#### 2.1 ASK(Aliyun Severless Kubernetes) PV/PVC 莫名其妙的 Lose

- 问题描述: 使用 Terraform 在 ASK 中创建的 PV/PVC 状态过一段 PVC 状态就从 Bound 变成了 Lose, 这个会导致所有引用 PVC 的 Container 处于一直 Pending 状态无法进行正常业务处理
- 原因: 查看 k8s 的 audit 日志, 发现 PVC 的状态有被更新成 Lost, 查看更新的操作的来源其实来自 Terraform, 如图:
  ![update pvc status](4290636159088.png)
  ![operator](1335619716611.png)
- 解决方案: 在 Terraform 中忽略 PV/PVC 的所有变更, 即 Terraform 只负责创建和删除, 不进行任何多余的维护, 维护的工作应该交给 Kubernetes

#### 2.2 日志服务 SLS

- 问题描述: 在 Container 中配置了`aliyun_logs_*`等环境变量但是最后看不日志项目
- 原因: 日志项目名称阿里云全局唯一, 我用的日志项目名称太简单了, 已经存在了
- 解决方案: 日志项目名称增加公司名前缀

#### 2.3 弹性容器实例 ECI API

- 问题描述: Pod 启动出错
- 原因: 触发了 ECI API 节流阈值
  ![4053715841454](4053715841454.png)
  ![5744833505703](5744833505703.png)
- 解决方案: 工单申请增加 ECI API 的阈值

#### 2.4 密钥管理服务 KMS

- 问题描述: Pod 启动失败, 代码进程报错退出
- 原因: 代码逻辑触发了 KMS API 节流
- 解决方案:
  - 提交工单申请更大的 KMS API 阈值
  - Code 修改捕获 Throttling 错误, 随机时长 delay 重试

#### 2.5 对象存储 OSS

- 问题描述: OSS 结合 CDN 使用后上传失败
- 原因: CDN 上传最大支持 300M, OSS 直传没有这个限制, 之所以一定要用 CDN 两个原因: a. 自定义域名; b. 下载频繁
- 解决方案: 无法解决, 前端上传时超过 300M 提醒用户

#### 2.6 弹性容器实例 ECI CPU 数量

- 问题描述: 压力测试逐步增加并发, 但是没有新的 Pod 都处于 ProviderFailure 状态
- 原因: ECI CPU 不够
  ![eci cpu](1501583789858.png)
- 解决方案: 提交工单增加 ECI CPU 阈值

#### 2.7 容器镜像服务 CR 个人版有流量限制

- 问题描述: pod 创建很慢, describe 之后发现其一直处于 image pull 的过程中, 慢的时候时长将近 20 分钟
- 限制描述: 企业 CR 只能添加三个 VPC, 如果有>=3 个 VPC 且想在内网拉取/推送镜像这是个限制
- 原因: CR 有个人版和企业之分, 考虑自身业务命名空间和仓库数目都比较小, 所以选择个人版本的容器镜像服务, 而个人版本的 CR 有流量上线
- 解决方案: 使用企业版 CR, 且将个人版仓库导入到企业版

#### 2.8 函数计算 FC 同步调用限制

- 限制描述: FC 同步调用会有 300 实例节流的限制, 即账号级别一个时间窗口最大支持 300 个服务实例
- 原因: 请求 1，2，3，4，5, ......, 300 ，这 300 个请求如果把实例用完了，第 301 个请求就报错限流了。但是如果在第 302 个请求来的时候，请求 1 已经处理完了，这个第 302 个请求就不会报错了
- 解决方案: a. 提交工单增加这个限制; b. 同步调用修改为异步调用
